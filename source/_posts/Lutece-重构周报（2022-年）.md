---
title: Lutece 重构周报（2022 年）
categories: 'Lutece'
toc: true
date: 2022-01-08 20:31:49
tags:
	- 开发
sticky: 100
---

为了避免自己摸鱼，每周写周报。

为了查阅方便，时间从近到远排。

<!-- more -->

## 2 月

### 02-26

#### 这周干了啥

装了一遍 Ubuntu Server，唯二出的问题就是不要连鼠标，选源的时候用 http 的，比如阿里云的源。用清华的 https 源莫名证书不对，很奇怪。

明白了一个道理，Stage 是在中台层面的抽象，发给测评机的请求只需要发 Phase 就可以了。然后就和 go-judge 差不多了……

更新了一下 xcpc-team-reg 的依赖，莫名发现了一个 nb 的 [fsnotify](https://github.com/fsnotify/fsnotify)，这样就可以监控程序新建文件什么的行为了。

又去打 USACO，怎么全特么是 DP 啊，佛了都，不想再打了。

开始读买的非文学性翻译理论与实践了。应该不会读得那么快。

校赛还有一个月。

#### 下周要干啥

下周~~要把自己绑在椅子上~~写 worker。

### 02-19

#### 这周干了啥

总之回学校了。

这周突然发现我忘考虑交互题了，统称 Stdin/Stdout 带管道的。Stage-Phase 那样的设计可能有点东西还要进一步细化。Run Stage 完事之后应该直接进 Judge Stage，但是如何分割运行过程是个问题。而且这么设计不方便合并数据组数很多的情况。

中台设计应该是这样的：先发一个 Compile 的 Stage 过去，再依次发 Run 和 Judge 的 Stage。那么这样就要保证 Run 和 Judge 的 Stage 要发给同样有 Compile 结果的机器，说实话我不知道这样会不会降低可用性。

这周大概感受了一下 Lyrio 的可用性，感觉比字节的基建可用性低多了，看到一些后端设计用 QUIC 我不太清楚怎么回事，感觉要一定设施支持，也可能是 TS 加成，总之可用性不高，后端的设计不太想参考了。

最近也是在想中型的 web 架构应该怎么设计，很难。

#### 下周要干啥

这周也没什么干劲，下周再努力吧.jpg

### 02-12

#### 这周干了啥

估期乐观了，实际上还有一堆事情没有解决。

这周在搞消息队列和 MinIO 数据同步那些事情，走了挺多弯路感觉。但是大概写法应该是可以确定了。

大概就是发送一整个请求，请求用 Stage 数组来描述，Stage 用 Phase 数组描述。一个 execution 请求只能在一台物理机上运行。之前考虑的是可以在多台物理机上运行，这样就涉及中间产物的移动问题，但对于在一台机器编译产物去另一台机器运行，或者另一个集群运行，感觉没什么好方法。

这个项目的意义应该在于可以应对所有单机黑盒测试问题了，通过自己编写工作流的方式。但是对于黑盒的集群测试，是没有办法的，需要换个方法，比如测评端提供 docker compose 和 k8s 的能力。

#### 下周要干啥

希望下周能发版。

### 02-05

#### 这周干了啥

先给大家拜个晚年，祝大家晚年幸福。

USACO 又打挂了，原因令人暖心。

决定把消息队列从 RocketMQ 换成 RabbitMQ，因为 RocketMQ 部署太麻烦了，有很多东西预设是有一台 nb 服务器的，比如上来就要 8G 内存。而且 RocketMQ 没有 docker 部署方案，所以溜了。

然后发现 RabbitMQ 的架构要重学，哈哈。[重学链接](https://blog.csdn.net/kavito/article/details/91403659)，真不想看英文了。

RabbitMQ 用 docker 部署需要调个时区，用 `-e TZ=CST` 不好使，所以要把本机的时间配置挂过去。大概运行命令就像这样：

```plain
docker run -d --hostname my-rabbit --name some-rabbit -p 5672:5672 -p 15672:15672 -v /etc/timezone:/etc/timezone:ro -v /etc/localtime:/etc/localtime:ro rabbitmq:alpine
```

然后其实应该很多配置都应该从中台拉下来的，比如 MQ 的地址，用户名密码，队列名称啥的，但是先在文件配置吧，等中台好了再说。

说实话真有点后悔，应该去复刻 Polygon 的，全是业务层的代码，写架构层代码太痛苦了。

#### 下周要干啥

目测下周进度快能发一个 execution-worker 的可迭代版本。

## 1 月

### 01-29

#### 这周干了啥

这周摸了，在打工会战，顺便还装了四台电脑，明天还要打 USACO，哈哈。

#### 下周要干啥

这周要干的

### 01-22

#### 这周干了啥

judge core 应该改个名，叫 execution worker 了。

在想搭流水线的事情，但是感觉很难。

首先大概写一下对于一些概念的定义。

系统管理的东西分为两部分：题目（Problems）和任务（Tasks）。题目描述了需要解决的问题。题目又分为题面（Statements）和附件（Attachments）两部分。题面是对一个现实要解决问题的具体文字描述，附件是帮助理解题面所用的各种附加文件。题目应该是具体且无二义性的。任务是评价用户是否解决了这个问题的唯一标准，一个任务对应一个题目。任务包括方法（Methods）和数据（Data），方法描述如何评价用户的提交，形式是工作流，工作流用阶段（Stages）描述，阶段用步骤（Phases）细化，并且只由步骤组成。阶段和步骤都有输入（Input）和输出（Output），阶段本身并不对应什么，而每个步骤都对应一个进程的运行。对于一个进程的描述和限制与 libcontainer 中的描述同。数据包括测试用例（Test cases）和辅助工具（Utilities）。以文件形式参与黑盒测试的所有文件都称之为测试用例，而辅助工具是测试中必要的，替代裁判手动操作或其他功能的工具，在测试时发挥作用。

比较正常的一个 Task 会经历的三个阶段是：编译（Compile），运行（Run），评分（Grade），一般后两个阶段被统称为测评（Judge），我们把它们分开，评分阶段也叫检查（Check），是因为 OI 和 XCPC 赛制的区别，XCPC 没有部分分。

对应到 worker 上的动作，其实只有准备（Prepare）和执行（Execute）两个。每次处理一个 Phase。

下面就是一些细节了。对于每个步骤的输入输出，它一定是一个文件，但是比如编译步骤，产生的输出是需要缓存到下一个阶段结束的，运行阶段的输出也需要缓存到评分阶段结束，所以可以设置一个 Expire time 去管理每个阶段的产物缓存时间，又比如交互器 grader，如果源文件不变，这个二进制实际上不会改变（会不会有奇妙技巧能让选手通过某种手段把二进制就莫名改了……），因此它的缓存期和其他文件也不一样，这样就可以避免重复编译同一份代码带来的时间消耗了。

然后 Test cases 全部分发到各个测评机上，实际上是可以接受的，但这样就涉及数据同步问题，比如主节点接到了数据更新，如何高可用地更新从节点数据，实际上是 Raft 解决的东西了。不想让测评机承担太多检查数据，作为某个其他功能从节点等等这样的任务……

然后把所有缓存都扔内存里，这也涉及到缓存大小等等的问题，一种方法是 Run 前 Preload 进去。

每台测评机在执行一个步骤之前都要先准备好这个步骤所需的东西，有一个方案是在这个阶段同步数据，先给主端发送目前的 Test cases 的 hash，然后主端 response 需要更新的数据。

还有一些其他的东西，比如 Prefork Container，没有对比性能提升的数据，也不知道 dry run 下的情况。应该做一下 AB 测的。

还有其他的管理细节，比如如何在主端注册一个 worker，发心跳包什么的。

在这里，资源管理应该按照 CPU 核心和内存大小粗粒度描述后再用 CPU 时间，栈大小等细粒度描述。

#### 下周要干啥

看看 RocketMQ 的 Go Client 怎么用，感觉官方版不太行。

不想让这个东西只能面向竞赛。但是也没找到啥其他卖点。可能可以放在 fuzzing 或者 CI/CD 上？

### 01-15

#### 这周干了啥

初期检查完事了，老师觉得还行。

然后发现 Github Page 好像被墙了……刚整理完就被墙了有点惨……

然后重写了一下 judge core，发现如果要写得比较 general 的话需要一套流水线来描述 judge 的过程，感觉好难写……

MinIO 确实有点过度设计了，但是它可能香。

春妈井了，哈哈。

LOJ 上留的坑翻译得差不多了，但是有几个题 checker 和 grader 没有，这几个月想摆了。

#### 下周要干啥

研究一下怎么搭这个流水线。

### 01-08

#### 这周干了啥

回家了，初期报告写完了但是 PPT 没做。

把博客重新用 Github Action 搞了一下，换了公式渲染，因为原来 Icarus 依赖的 Hexo 版本有一个 XSS 的 CVE，所以直接换主题到了 NeXT，顺便修了一下评论，但是原来的评论全都无了……

还发现原来博客里引的许多链接都失效了，有些是把自己的博客下掉了，还有 HDOJ 倒了等其他问题……

~~还发现原来的博客有些地方写得过于啥b~~

然后发现 judge core 架构又要重写了，已经重写三次了……现在连个 0.0.1 可迭代版都无，有点崩溃。

#### 下周要干啥

初期答辩希望能过
