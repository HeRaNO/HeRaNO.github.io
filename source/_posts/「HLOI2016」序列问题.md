---
title: 「HLOI2016」序列问题
categories: 'OI/ICPC'
date: 2017-02-18 19:54:35
tags:
	- HLOI
	- 线段树
	- 矩阵
toc: true
description: HLOI2016 Day2 T2
---

## 题目描述
现定义序列它的第 $i$ 项为：

$$F_i=S_{i-1}\times F_{i-1}+S_{i-2}\times F_{i-2}$$

定义 $F_0=0$ 以及 $F_1=1$。

其中，$S$ 是一个无限长的，几乎循环的一个数字序列，它的循环节长度为 $N$，也就是说，通常会有 $S_i=S_{i\bmod N}$。但是 $S$ 中也存在少数元素并不符合这个循环节，也就是说，会有若干个元素，$S_i\neq S_{i\bmod N}$。

现在给出序列 $S$ 的循环节，以及 $S$ 中不符合循环的位置以及值，求 $F_k\bmod P$。

## 输入
输入的第一行有两个整数 $K$ 和 $P$；

第二行是一个整数 $N$；

第三行包含 $N$ 个正整数，表示循环节中所有的数字；

接下来一行是一个整数 $M$。接下来的 $M$ 行，每行包含两个整数 $x$ 和 $y$，表示在序列 $S$ 中不符合循环节的位置以及相应位置上的值，即 $S_x=y$。

## 输出
输出包含一个整数，即相应输入文件的答案。

## 样例输入
```
42 1248493
5
5 2 4 1 6
5
9 3
8 4
21 21
10 18
24 10
```
## 样例输出
```
232959
```

## 数据范围及约定
对于 $30\%$ 的数据：$0\le k\le 10^4,1\le n\le 10^3,1\le M\le 20$；

对于 $70\%$ 的数据：$0\le k\le 10^{18},1\le n\le 10^3,1\le M\le 20$；

对于 $100\%$ 的数据：$0\le k\le 10^{18},1\le n,m\le 5\times 10^4,1\le p\le 10^9,1\le S_i\le 10^9,n\le x\le 10^{18},1\le y\le 10^9$。

## 时间与空间限制
时间限制：$2000\text{ms}$，空间限制：$128\text{MB}$。

## 题解
一看 $k$ 这么大快速幂逃不掉了……

一看递推关系矩阵逃不掉了……

所以矩阵快速幂逃不掉了。

~~MDZZ~~ 怎么搞矩阵？

这回在化学课上推公式……

$$
\begin{align}
f_0&=0\\
f_1&=1\\
f_2&=s_1f_1=s_1\\
f_3&=s_2f_2+s_1f_1=s_1s_2+s_1\\
f_4&=s_3f_3+s_2f_2=s_1s_2s_3+s_1s_2+s_1s_3\\
\ldots
\end{align}
$$

看出什么来了吗？~~反正我看了一天~~

可以看出这个 $f$ 只与 $s$ 有关……

假如能搞出一个矩阵的话，可以借鉴分块思想，将一个循环节看成一个块，将整个块内的值求出后，跑矩阵快速幂，之后零散部分暴力。

可是有修改……？

就将修改看成断点，假如断点处于同一块内，暴力即可，如果不在，零散暴力，整块快速幂。
时间为 $\mathcal{O}(mn\log k)$，这样可以过 $70\%$……

$100\%$ 优化的是零散部分，因为要不停计算零散部分，这些零散部分还是循环的，所以可以用线段树优化。

所以，怎么构造矩阵？

两个矩阵，一个是处理影响的，一个是统计答案的。

统计答案的矩阵是一个 $1\times2$ 的矩阵：

$$
\begin{bmatrix}
f_{a+1}& f_a
\end{bmatrix}
$$

当然也可以写成 $2\times2$ 的，其余补 $0$ 即可。

处理影响的矩阵是一个 $2\times2$ 的矩阵：

$$
\begin{bmatrix}
0 & s_{a}\\
1 & s_{a+1}
\end{bmatrix}
$$

遇到断点答案矩阵暴力乘矩阵即可，此矩阵为：

$$
\begin{bmatrix}
0&s_{x-1}\\
1&c
\end{bmatrix}
$$

其中 $x$ 为需要修改的位置，$c$ 为变换成的数。

这还没完，因为矩阵与 $x+1$ 位置也有关，还需要乘：

$$
\begin{bmatrix}
0&c\\
1&s_{x+1}
\end{bmatrix}
$$

这样就可以了。

时间复杂度为 $\mathcal{O}(m\log n\log k)$，空间复杂度为 $\mathcal{O}(n)$。

还有一些~~许多~~细节需要注意……具体参见代码。

代码见[这里](https://github.com/HeRaNO/OI-ICPC-Codes/blob/master/HSAHRBNUOJ/P38xx/P3875.cpp)。
