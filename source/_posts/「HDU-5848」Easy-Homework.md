---
title: 「HDU 5848」Easy Homework
categories: 'OI/ICPC'
date: 2021-07-31 10:52:40
tags:
	- 数学
	- 数论
	- 矩阵
	- BSGS
description: ' '
---

题目[传送门](https://vjudge.net/problem/HDU-5848)

题目大意是给定一个广义 Fibonacci 数列 $f_n=Af_{n-1}+f_{n-2}$，其中 $f_0=0,f_1=1$，求有多少 $n$ 在 $[L,R]$ 范围内，满足 $f_n\bmod p=x$。

首先 $L,R$ 的范围很大，考虑模意义下的广义 Fibonacci 数列的循环节长度大概是 $\mathcal{O}(p)$ 的，$p$ 是模数，因此我们先把循环节求出来。

求广义 Fibonacci 数列循环节在[这篇文章](https://blog.csdn.net/ACdreamers/article/details/25616461)给出了详细证明过程，在本题的结论是：

- 若 $a^2+4$ 是模 $p$ 的二次剩余，则最小循环节长度是 $p-1$ 的一个因子；
- 若 $a^2+4$ 不是模 $p$ 的二次剩余，则最小循环节长度是 $p^2-1$ 的一个因子；
- 若 $(a^2+4)\bmod p=0$，则最小循环节长度为 $4p$。

最后一条结论不会证明，但是跑了 $10^9$ 以内的满足条件的数应该都是满足的。

所以套用 Pollard Rho 即可进行快速的因数枚举，之后使用矩阵快速幂判断是否是循环节即可，复杂度是 $\mathcal{O}(d(n)\log n)$，$d(n)$ 指的是 $n$ 的因数个数。

现在我们把整个序列的范围缩小到了一个 $\mathcal{O}(p)$ 长度的循环节内，下面考虑一个循环节内模 $p$ 为 $x$ 的位置怎么求。考虑一个经典题是给两个数，问在广义 Fibonacci 数列出现的位置，这个是用这两个数构造矩阵，用 BSGS 求即可。这里只出现了一个数，没办法构造矩阵的。

考虑 Cassini's identity，有 $f_{n+1}f_{n-1}-f_n^2=(-1)^n$。这里按照行列式证明的方式，易知本题中这个性质仍然满足。因此设 $f_{n-1}=y$，则方程

$$
(Ax+y)y-x^2=(-1)^n
$$

成立。

因为我们要求出 $y$ 才能根据 $y$ 和 $x$ 求出 $n$，但所有满足条件的解一定满足方程，所以我们先讨论奇偶，然后发现这个是一个模意义下解二次方程。利用求根公式求，如果根号下的数在模 $p$ 意义下不存在二次剩余，则忽略它，因为要求的是实根，否则找个二次剩余板子把解求出来，然后套用上面提到的 BSGS 把位置求出来。

根据方程性质，可以知道在一个循环节内最多有 $4$ 个解，然后就套用 BSGS 求位置，根据循环节长度算算即可。

然后就会收到一个大大的 TLE。

仔细分析，因为我们求解的是一个矩阵 $B^x=M$，其中：

$$
B=
\begin{bmatrix}
a & 1\\
1 & 0
\end{bmatrix}
$$

$M$ 是我们构造的矩阵。按照正常的矩阵求解，是拆成 $x=im-j$ 而非 $x=im+j$ 的形式以避免矩阵求逆，但是拆成 $x=im-j$ 的话第一步小步的值需要求四次，而拆成 $x=im+j$ 的话小步的结果就可以保留下来，大步中还能复用。所幸 $B$ 是可逆的，因此根据这个性质，就从原来的最大 $8\sqrt p$ 的 BSGS 过程变成了 $5\sqrt p$，就能卡过去了。

时间复杂度：$\mathcal{O}(T\sqrt{p})$，空间复杂度：$\mathcal{O}(T\sqrt{p})$。

代码在[这里](https://github.com/HeRaNO/OI-ICPC-Codes/blob/master/HDU/HDU5848.cpp)
