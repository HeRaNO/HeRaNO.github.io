---
title: Lutece 重构周报（2022 年）
categories: 'Lutece'
toc: true
date: 2022-01-08 20:31:49
tags:
	- 开发
sticky: 100
---

为了避免自己摸鱼，每周写周报。

为了查阅方便，时间从近到远排。

<!-- more -->

## 1 月

### 01-22

#### 这周干了啥

judge core 应该改个名，叫 execution worker 了。

在想搭流水线的事情，但是感觉很难。

首先大概写一下对于一些概念的定义。

系统管理的东西分为两部分：题目（Problems）和任务（Tasks）。题目描述了需要解决的问题。题目又分为题面（Statements）和附件（Attachments）两部分。题面是对一个现实要解决问题的具体文字描述，附件是帮助理解题面所用的各种附加文件。题目应该是具体且无二义性的。任务是评价用户是否解决了这个问题的唯一标准，一个任务对应一个题目。任务包括方法（Methods）和数据（Data），方法描述如何评价用户的提交，形式是工作流，工作流用阶段（Stages）描述，阶段用步骤（Phases）细化，并且只由步骤组成。阶段和步骤都有输入（Input）和输出（Output），阶段本身并不对应什么，而每个步骤都对应一个进程的运行。对于一个进程的描述和限制与 libcontainer 中的描述同。数据包括测试用例（Test cases）和辅助工具（Utilities）。以文件形式参与黑盒测试的所有文件都称之为测试用例，而辅助工具是测试中必要的，替代裁判手动操作或其他功能的工具，在测试时发挥作用。

比较正常的一个 Task 会经历的三个阶段是：编译（Compile），运行（Run），评分（Grade），一般后两个阶段被统称为测评（Judge），我们把它们分开，评分阶段也叫检查（Check），是因为 OI 和 XCPC 赛制的区别，XCPC 没有部分分。

对应到 worker 上的动作，其实只有准备（Prepare）和执行（Execute）两个。每次处理一个 Phase。

下面就是一些细节了。对于每个步骤的输入输出，它一定是一个文件，但是比如编译步骤，产生的输出是需要缓存到下一个阶段结束的，运行阶段的输出也需要缓存到评分阶段结束，所以可以设置一个 Expire time 去管理每个阶段的产物缓存时间，又比如交互器 grader，如果源文件不变，这个二进制实际上不会改变（会不会有奇妙技巧能让选手通过某种手段把二进制就莫名改了……），因此它的缓存期和其他文件也不一样，这样就可以避免重复编译同一份代码带来的时间消耗了。

然后 Test cases 全部分发到各个测评机上，实际上是可以接受的，但这样就涉及数据同步问题，比如主节点接到了数据更新，如何高可用地更新从节点数据，实际上是 Raft 解决的东西了。不想让测评机承担太多检查数据，作为某个其他功能从节点等等这样的任务……

然后把所有缓存都扔内存里，这也涉及到缓存大小等等的问题，一种方法是 Run 前 Preload 进去。

每台测评机在执行一个步骤之前都要先准备好这个步骤所需的东西，有一个方案是在这个阶段同步数据，先给主端发送目前的 Test cases 的 hash，然后主端 response 需要更新的数据。

还有一些其他的东西，比如 Prefork Container，没有对比性能提升的数据，也不知道 dry run 下的情况。应该做一下 AB 测的。

还有其他的管理细节，比如如何在主端注册一个 worker，发心跳包什么的。

在这里，资源管理应该按照 CPU 核心和内存大小粗粒度描述后再用 CPU 时间，栈大小等细粒度描述。

#### 下周要干啥

看看 RocketMQ 的 Go Client 怎么用，感觉官方版不太行。

不想让这个东西只能面向竞赛。但是也没找到啥其他卖点。可能可以放在 fuzzing 或者 CI/CD 上？

### 01-15

#### 这周干了啥

初期检查完事了，老师觉得还行。

然后发现 Github Page 好像被墙了……刚整理完就被墙了有点惨……

然后重写了一下 judge core，发现如果要写得比较 general 的话需要一套流水线来描述 judge 的过程，感觉好难写……

MinIO 确实有点过度设计了，但是它可能香。

春妈井了，哈哈。

LOJ 上留的坑翻译得差不多了，但是有几个题 checker 和 grader 没有，这几个月想摆了。

#### 下周要干啥

研究一下怎么搭这个流水线。

### 01-08

#### 这周干了啥

回家了，初期报告写完了但是 PPT 没做。

把博客重新用 Github Action 搞了一下，换了公式渲染，因为原来 Icarus 依赖的 Hexo 版本有一个 XSS 的 CVE，所以直接换主题到了 NeXT，顺便修了一下评论，但是原来的评论全都无了……

还发现原来博客里引的许多链接都失效了，有些是把自己的博客下掉了，还有 HDOJ 倒了等其他问题……

~~还发现原来的博客有些地方写得过于啥b~~

然后发现 judge core 架构又要重写了，已经重写三次了……现在连个 0.0.1 可迭代版都无，有点崩溃。

#### 下周要干啥

初期答辩希望能过
